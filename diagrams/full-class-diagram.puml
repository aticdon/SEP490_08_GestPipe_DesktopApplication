@startuml GestPipe_Full_Class_Diagram

' Styling
skinparam class {
    BackgroundColor<<Entity>> LightBlue
    BackgroundColor<<Service>> LightGreen
    BackgroundColor<<Controller>> LightYellow
    BackgroundColor<<DTO>> LightGray
    BackgroundColor<<ValueObject>> Pink
}

skinparam packageStyle rectangle

' ============== DOMAIN MODELS ==============

package "Domain Models" {
    
    ' User Management
    class User <<Entity>> {
        + Id: string
        + Email: string
        + PasswordHash: string
        + AccountStatus: string
        + GestureRequestStatus: string
        + UiLanguage: string?
        + AvatarUrl: string
        + RequestCountToday: int
        + CreatedAt: DateTime
        + LastLogin: DateTime?
        + VersionGestureId: string?
        + AuthProvider: string?
        + ProviderId: string?
        + EmailVerified: bool
    }
    
    class UserProfile <<Entity>> {
        + Id: string
        + UserId: string
        + FullName: string?
        + UpdatedAt: DateTime?
        + Occupation: string?
        + Company: string?
        + BirthDate: DateTime?
        + EducationLevel: string?
        + PhoneNumber: string?
        + Gender: string?
        + Address: string?
    }
    
    class Otp <<Entity>> {
        + Email: string
        + OtpCode: string
        + Purpose: string
        + CreatedAt: DateTime
        + ExpiresAt: DateTime
        + AttemptsCount: int
        + IsExpired(): bool
    }
    
    ' Gesture Management
    class GestureType <<Entity>> {
        + Id: string
        + TypeName: Dictionary<string, string>
        + Code: Dictionary<string, string>
    }
    
    class DefaultGesture <<Entity>> {
        + Id: string
        + VersionId: string
        + GestureTypeId: string
        + PoseLabel: string
        + Status: Dictionary<string, string>
        + Accuracy: double
        + CreatedAt: DateTime
        + VectorData: VectorData
    }
    
    class UserGestureConfig <<Entity>> {
        + Id: string
        + UserId: string
        + GestureTypeId: string
        + PoseLabel: string
        + Status: Dictionary<string, string>
        + Accuracy: double
        + UpdateAt: DateTime
        + VectorData: VectorData
    }
    
    class TrainingGesture <<Entity>> {
        + Id: string
        + UserId: string
        + PoseLabel: string
        + TotalTrain: int
        + CorrectTrain: int
        + Accuracy: double
        + VectorData: VectorData
        + CreateAt: DateTime
    }
    
    class UserGestureRequest <<Entity>> {
        + Id: string
        + UserId: string
        + UserGestureConfigId: string
        + GestureTypeId: string
        + PoseLabel: string
        + Status: Dictionary<string, string>
        + CreatedAt: DateTime
    }
    
    class VectorData <<ValueObject>> {
        + Fingers: int[]
        + MainAxisX: double
        + MainAxisY: double
        + DeltaX: double
        + DeltaY: double
    }
    
    ' Content Management
    class Category <<Entity>> {
        + Id: string
        + Name: Dictionary<string, string>
    }
    
    class Topic <<Entity>> {
        + Id: string
        + Title: Dictionary<string, string>
        + CategoryId: string
        + Description: string
        + Difficulty: string
    }
    
    class Session <<Entity>> {
        + Id: string
        + UserId: string
        + CategoryId: string
        + TopicId: string
        + Records: Dictionary<string, int>
        + Duration: double
        + CreatedAt: DateTime
    }
}

' ============== RELATIONSHIPS ==============

' User relationships
User "1" -- "1" UserProfile : has
User "1" -- "*" UserGestureConfig : configures
User "1" -- "*" TrainingGesture : trains
User "1" -- "*" Session : participates
User "1" -- "*" UserGestureRequest : requests

' Gesture relationships
GestureType "1" -- "*" DefaultGesture : defines
GestureType "1" -- "*" UserGestureConfig : types
GestureType "1" -- "*" UserGestureRequest : types

DefaultGesture *-- VectorData : contains
UserGestureConfig *-- VectorData : contains
TrainingGesture *-- VectorData : contains

UserGestureConfig "1" -- "*" UserGestureRequest : basis for

' Content relationships
Category "1" -- "*" Topic : contains
Category "1" -- "*" Session : categorizes
Topic "1" -- "*" Session : includes

' ============== SERVICES ==============

package "Service Layer" {
    
    interface IAuthService <<Service>> {
        + RegisterAsync(RegisterDto): Task<AuthResponseDto>
        + LoginAsync(LoginDto, ip, agent): Task<AuthResponseDto>
        + VerifyOtpAsync(VerifyOtpDto): Task<AuthResponseDto>
        + GoogleLoginAsync(token, ip, agent): Task<AuthResponseDto>
        + ForgotPasswordAsync(email): Task<AuthResponseDto>
        + ResetPasswordAsync(ResetPasswordDto): Task<AuthResponseDto>
        + LogoutAsync(userId): Task<AuthResponseDto>
        + GetUserByEmailAsync(email): Task<User>
    }
    
    interface IUserService <<Service>> {
        ' User management methods
    }
    
    interface IProfileService <<Service>> {
        ' Profile management methods
    }
    
    interface IOtpService <<Service>> {
        + GenerateOtpAsync(userId, email, purpose): Task<string>
        + ValidateOtpAsync(email, code, purpose): Task<bool>
        + MarkOtpAsVerifiedAsync(email, code): Task<bool>
        + IsOtpLimitExceededAsync(email): Task<bool>
    }
    
    interface IEmailService <<Service>> {
        + SendVerificationEmailAsync(email, otp): Task
        + SendPasswordResetEmailAsync(email, otp): Task
    }
    
    interface IGestureTypeService <<Service>> {
        ' Gesture type methods
    }
    
    interface IDefaultGestureService <<Service>> {
        ' Default gesture methods
    }
    
    interface IUserGestureConfigService <<Service>> {
        ' User gesture config methods
    }
    
    interface ITrainingGestureService <<Service>> {
        ' Training gesture methods
    }
    
    interface IUserGestureRequestService <<Service>> {
        ' User gesture request methods
    }
    
    interface IGestureInitializationService <<Service>> {
        + InitializeUserGesturesAsync(userId): Task
        + GetUserGestureStatsAsync(userId): Task<GestureStats>
    }
    
    class AuthService <<Service>> {
    }
    
    class UserService <<Service>> {
    }
    
    class ProfileService <<Service>> {
    }
    
    class OtpService <<Service>> {
    }
    
    class EmailService <<Service>> {
    }
    
    class GestureTypeService <<Service>> {
    }
    
    class DefaultGestureService <<Service>> {
    }
    
    class UserGestureConfigService <<Service>> {
    }
    
    class TrainingGestureService <<Service>> {
    }
    
    class UserGestureRequestService <<Service>> {
    }
    
    class GestureInitializationService <<Service>> {
    }
    
    class TopicService <<Service>> {
    }
    
    class SessionService <<Service>> {
    }
    
    class CategoryService <<Service>> {
    }
}

' Service implementations
AuthService ..|> IAuthService
UserService ..|> IUserService
ProfileService ..|> IProfileService
OtpService ..|> IOtpService
EmailService ..|> IEmailService
GestureTypeService ..|> IGestureTypeService
DefaultGestureService ..|> IDefaultGestureService
UserGestureConfigService ..|> IUserGestureConfigService
TrainingGestureService ..|> ITrainingGestureService
UserGestureRequestService ..|> IUserGestureRequestService
GestureInitializationService ..|> IGestureInitializationService

' ============== CONTROLLERS ==============

package "Controllers" {
    
    class AuthController <<Controller>> {
        - _authService: IAuthService
        - _otpService: IOtpService
        - _emailService: IEmailService
        - _gestureInitService: IGestureInitializationService
        + Register(RegisterDto): IActionResult
        + Login(LoginDto): IActionResult
        + ValidateOtp(VerifyOtpDto): IActionResult
        + GoogleLogin(GoogleLoginDto): IActionResult
        + Logout(): IActionResult
    }
    
    class UserController <<Controller>> {
        - _userService: IUserService
    }
    
    class ProfileController <<Controller>> {
        - _profileService: IProfileService
    }
    
    class GestureTypeController <<Controller>> {
        - _gestureTypeService: IGestureTypeService
    }
    
    class DefaultGestureController <<Controller>> {
        - _defaultGestureService: IDefaultGestureService
    }
    
    class UserGestureConfigController <<Controller>> {
        - _userGestureConfigService: IUserGestureConfigService
    }
    
    class TrainingGestureController <<Controller>> {
        - _trainingGestureService: ITrainingGestureService
    }
    
    class UserGestureRequestController <<Controller>> {
        - _userGestureRequestService: IUserGestureRequestService
    }
    
    class TopicController <<Controller>> {
        - _topicService: TopicService
    }
    
    class CategoryController <<Controller>> {
        - _categoryService: CategoryService
    }
    
    class SessionController <<Controller>> {
        - _sessionService: SessionService
    }
}

' Controller dependencies
AuthController ..> IAuthService : uses
AuthController ..> IOtpService : uses
AuthController ..> IEmailService : uses
AuthController ..> IGestureInitializationService : uses

UserController ..> IUserService : uses
ProfileController ..> IProfileService : uses
GestureTypeController ..> IGestureTypeService : uses
DefaultGestureController ..> IDefaultGestureService : uses
UserGestureConfigController ..> IUserGestureConfigService : uses
TrainingGestureController ..> ITrainingGestureService : uses
UserGestureRequestController ..> IUserGestureRequestService : uses
TopicController ..> TopicService : uses
CategoryController ..> CategoryService : uses
SessionController ..> SessionService : uses

' Service to Model dependencies (selected examples)
IAuthService ..> User : manages
IProfileService ..> UserProfile : manages
IUserGestureConfigService ..> UserGestureConfig : manages
ITrainingGestureService ..> TrainingGesture : manages
IOtpService ..> Otp : manages

note right of VectorData
  Value Object nhúng trong
  DefaultGesture, UserGestureConfig,
  và TrainingGesture
end note

note right of User
  AccountStatus:
  - inactive
  - activeonline
  - activeoffline
  - pending
  - blocked
end note

note right of Otp
  Purpose:
  - registration
  - resetpassword
end note

@enduml
